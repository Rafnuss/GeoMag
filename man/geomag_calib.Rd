% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/geomag_calib.R
\name{geomag_calib}
\alias{geomag_calib}
\title{Calibrate Magnetic and Acceleration Data for 3-Axis Sensors}
\usage{
geomag_calib(
  tag,
  calib_data = NULL,
  calib_method = NULL,
  rm_outlier = TRUE,
  quiet = FALSE
)
}
\arguments{
\item{tag}{A \code{GeoPressureR} tag object containing magnetic and acceleration data.}

\item{calib_data}{Logical, character, or \code{NULL}.
If \code{TRUE}, uses calibration data from \verb{magCalib/} subfolder.
If \code{FALSE}, calibrates using in situ data.
If a character path, uses calibration data from the specified directory.
If \code{NULL}, auto-detects calibration folder.}

\item{calib_method}{Character. Calibration method, one of \code{"sphere"}, \code{"ellipse"},
\code{"near-sphere"}, \code{"sphere_stap"}, or \code{"ellipse_stap"}. If \code{NULL}, chosen automatically.}

\item{rm_outlier}{Logical. If \code{TRUE}, removes outliers from calibration data (recommended).}

\item{quiet}{Logical. If \code{TRUE}, suppresses progress messages.}
}
\value{
Modified \code{GeoPressureR} tag object. The \verb{$magnetic} data frame contains:
\itemize{
\item \code{date}: Timestamp (POSIXct or numeric)
\item \code{acceleration_x}, \code{acceleration_y}, \code{acceleration_z}: Raw acceleration data
\item \code{magnetic_x}, \code{magnetic_y}, \code{magnetic_z}: Raw magnetic data
\item \code{is_static}: Scaled MAD of acceleration (0 = static, >1 = movement)
\item \code{pitch}, \code{roll}: Orientation angles (radian)
\item \code{acceleration_xp}, \code{acceleration_yp}, \code{acceleration_zp}: Gravity projected in NED frame
\item \code{is_outlier}: Logical, marks outliers in magnetic data
\item \code{magnetic_xc}, \code{magnetic_yc}, \code{magnetic_zc}: Calibrated magnetic data
\item \code{magnetic_xcp}, \code{magnetic_ycp}, \code{magnetic_zcp}: Calibrated magnetic data projected in NED
frame
\item \code{H}: Heading (radian, North=0)
\item \code{F}: Magnetic field intensity (Gauss)
\item \code{I}: Inclination (radian)
Also returns (invisibly) the calibration dataset used (\code{tag$mag_calib}) and calibration
parameters (\code{tag$param$geomag_calib}).
}
}
\description{
Performs tilt compensation and magnetic calibration for 3-axis sensor data, with support for
in situ and in vitro calibration routines, outlier removal, and computation of orientation and
field parameters. This function is designed for use with \code{GeoPressureR} tag objects and can
utilize calibration datasets if available.
\subsection{Workflow}{
\enumerate{
\item \strong{Determine static/movement states:}
Classify each data point as static or moving by evaluating acceleration signals.
\item \strong{Magnetic Data Calibration:}
\itemize{
\item Select calibration data source (raw or from calibration dataset).
\item Optionally remove extreme or outlier values.
\item Fit and apply a calibration model (sphere/ellipse or their stap variants).
}
\item \strong{Tilt Compensation:}
\itemize{
\item Compute pitch and roll from acceleration.
\item Project gravity and calibrated magnetic data into the horizontal plane of the Earth frame.
}
\item \strong{Orientation and Field Parameters:}
\itemize{
\item Calculate heading, field intensity, and inclination.
\item Store calibration metadata and processed data in the tag object.
}
}
}
}
\section{Details}{

This function is part of the \code{GeoMag} package and is intended for use with animal-attached tags
that record magnetic and acceleration data. It supports several calibration workflows and robust
outlier detection.
}

\examples{
library(GeoPressureR)
withr::with_dir(system.file("extdata", package = "GeoMag"), {
  tag <- tag_create("14DM", quiet = TRUE)
  tag <- tag_label(tag, quiet = TRUE)
  tag <- geomag_calib(tag, quiet = TRUE)
  tag$param$geomag_calib
  head(tag$magnetic)
})
}
